---
title: "Using ccostr"
author: "HAEM AALBORG"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

This vignettes shows how to use the functions of the ccostr package and how to verify the estimates in the ccmean function 

```{r echo=TRUE, message=FALSE, warning=FALSE}
library(tidyverse)
library(survival)
library(ccostr)
library(parallel)
library(msm)
library(knitr)
```

# Replication of hcost estimates
In the ccostr package a dataset called hcost is included, we use the ccmean function with a limit of 4 years (1461 days)

```{r}
head(hcost)

ccmean(hcost, L = 1461)
```

We see how the BT and ZT estimators are higher than AS and CC, this is due to downward bias in AS and CC

## Simulation of data
The ccostr package includes a function to simulate data, the cost function takes the following form:

$$M_i = M_i(0)+b_iT_i^L+\sum^{10}_{j=1}\tau_{ij}(min[\{T_i^L-(j-1)\}^+,1])+d_iI(T_i\leq10)$$

With a uniform distribution this is set to take the value of 40.000, we can now test the estimators:

```{r fig.height=3, fig.width=6}
sim <- simCostData(n = 1000, dist = "unif", censor = "light", L = 10)

c2 <- ccmean(sim$censoredCostHistory)
c2
```

We can plot this

```{r}
plot(c2) + geom_hline(yintercept = 40000, linetype = "dotted", size = 1)
```


## bias and coverage
We can now test the bias of the estimators and their coverage with the simulated data

```{r}
nSim   <- 1000
nYears <- 10
indv   <- 500

## true mean for unif is 40000 and exp is 35956

unif_light <- lapply(1:nSim, function(x) simCostData(n = indv, dist = "unif", censor = "light", L = nYears))
unif_heavy <- lapply(1:nSim, function(x) simCostData(n = indv, dist = "unif", censor = "heavy", L = nYears))
exp_light  <- lapply(1:nSim, function(x) simCostData(n = indv, dist = "exp",  censor = "light", L = nYears))
exp_heavy  <- lapply(1:nSim, function(x) simCostData(n = indv, dist = "exp",  censor = "heavy", L = nYears))
```

### Results
```{r message=FALSE, warning=FALSE}
### Estimate from censored data
nCores <- 1
cl <- makeCluster(nCores)
clusterExport(cl = cl, c("unif_light", "unif_heavy", "exp_light", "exp_heavy"))
clusterEvalQ(cl = cl, {
  library(dplyr)
  library(ccostr)
  library(survival)})
est_unif_light <- parLapply(cl, unif_light, function(x) ccmean(x$censoredCostHistory, L = 10))
est_unif_heavy <- parLapply(cl, unif_heavy, function(x) ccmean(x$censoredCostHistory, L = 10))
est_exp_light  <- parLapply(cl, exp_light,  function(x) ccmean(x$censoredCostHistory, L = 10))
est_exp_heavy  <- parLapply(cl, exp_heavy,  function(x) ccmean(x$censoredCostHistory, L = 10))
stopCluster(cl)

## Summarize
results_unif_light <- do.call(rbind, lapply(est_unif_light, function(x) x[[3]]))
results_unif_heavy <- do.call(rbind, lapply(est_unif_heavy, function(x) x[[3]]))
results_exp_light  <- do.call(rbind, lapply(est_exp_light,  function(x) x[[3]]))
results_exp_heavy  <- do.call(rbind, lapply(est_exp_heavy,  function(x) x[[3]]))

results_true <- data.frame("unif_light" = 40000,
                           "unif_heavy" = 40000,
                           "exp_light"  = 35956,
                           "exp_heavy"  = 35956)

results_mean <- data.frame("unif_light" = mean(sapply(unif_light, function(x) mean(x$totalCost))),
                           "unif_heavy" = mean(sapply(unif_heavy, function(x) mean(x$totalCost))),
                           "exp_light"  = mean(sapply(exp_light, function(x) mean(x$totalCost))),
                           "exp_heavy"  = mean(sapply(exp_heavy, function(x) mean(x$totalCost))))

results_bias <- data.frame("unif_light" = (colMeans(results_unif_light)),
                           "unif_heavy" = (colMeans(results_unif_heavy)),
                           "exp_light"  = (colMeans(results_exp_light)),
                           "exp_heavy"  = (colMeans(results_exp_heavy)))

results <- rbind(results_true, results_mean, results_bias)
row.names(results) <- c("true_mean", "simulation_mean", colnames(results_unif_light))
kable(results)
```

### Bias
```{r}
results_bias <- cbind(round(results[,c(1,2)] - 40000,2), 
                      round(results[,c(3,4)] - 35956,2))
kable(results_bias)
```


### Coverage
```{r}
cov_unif_light <- do.call(rbind, lapply(est_unif_light, function(x) ifelse(x[[4]][4,] >= 40000 & x[[4]][5,] <= 40000, 1, 0)))
cov_unif_heavy <- do.call(rbind, lapply(est_unif_heavy, function(x) ifelse(x[[4]][4,] >= 40000 & x[[4]][5,] <= 40000, 1, 0)))
cov_exp_light  <- do.call(rbind, lapply(est_exp_light,  function(x) ifelse(x[[4]][4,] >= 35956 & x[[4]][5,] <= 35956, 1, 0)))
cov_exp_heavy  <- do.call(rbind, lapply(est_exp_heavy,  function(x) ifelse(x[[4]][4,] >= 35956 & x[[4]][5,] <= 35956, 1, 0)))

results_coverage <- data.frame("unif_light" = (colMeans(cov_unif_light, na.rm = T)),
                               "unif_heavy" = (colMeans(cov_unif_heavy, na.rm = T)),
                               "exp_light"  = (colMeans(cov_exp_light,  na.rm = T)),
                               "exp_heavy"  = (colMeans(cov_exp_heavy,  na.rm = T)))
kable(results_coverage, digits = 3)
```
















